name: Sync Docker Images to Any Container Registry

on:
  workflow_dispatch:
  push:
    paths:
      - images-list.txt

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Target Registry
        run: echo "${{ secrets.ACR_PASSWORD }}" | docker login "${{ secrets.ACR_REGISTRY }}" -u "${{ secrets.ACR_USERNAME }}" --password-stdin

      - name: Sync Docker Images
        run: |
          MAX_PARALLEL=4  # 并发数限制，可根据需要调整
          JOBS=0
      
          echo "=== Start syncing ==="
          
          sync_image() {
            local image="$1"
      
            [[ "$image" != *:* ]] && image="${image}:latest"
            name_with_tag=$(basename "$image")
            name=${name_with_tag%%:*}
            tag=${name_with_tag#*:}
            target="${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/$name:$tag"
      
            echo "==> Syncing $image → $target"
      
            docker pull "$image" && \
            docker tag "$image" "$target" && \
            docker push "$target" && \
            echo "✅ Done: $image" || \
            echo "❌ Failed: $image"
          }
      
          while IFS= read -r image || [[ -n "$image" ]]; do
            # 去除空行和注释
            [[ -z "$image" || "$image" =~ ^# ]] && continue
      
            sync_image "$image" &
      
            ((JOBS++))
            if [[ "$JOBS" -ge "$MAX_PARALLEL" ]]; then
              wait -n  # 等待任意一个任务完成
              ((JOBS--))
            fi
          done < images-list.txt
      
          wait  # 等待所有剩余任务完成
